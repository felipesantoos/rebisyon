<% content_for :title, "Study: #{@deck.name}" %>

<%# Hide sidebar layout for immersive study %>
<% content_for :page_title, "" %>
<% content_for :page_actions do %><% end %>

<div data-controller="study"
     data-study-card-id-value="<%= @card.id %>"
     data-study-deck-id-value="<%= @deck.id %>"
     data-study-show-answer-url-value="<%= show_answer_deck_study_session_path(@deck) %>"
     data-study-answer-url-value="<%= answer_deck_study_session_path(@deck) %>"
     class="-m-6 flex flex-col h-[calc(100vh-57px)] bg-gray-50">

  <%# Top bar: deck name + counts %>
  <div class="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between flex-shrink-0">
    <div class="flex items-center gap-3">
      <%= link_to deck_path(@deck), class: "text-gray-400 hover:text-gray-600" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      <% end %>
      <span class="text-sm font-medium text-gray-700"><%= @deck.name %></span>
    </div>
    <div class="flex items-center gap-4 text-sm font-semibold">
      <span class="count-new"><%= @session_stats[:new_remaining] || 0 %></span>
      <span class="text-gray-300">+</span>
      <span class="count-learning"><%= @session_stats[:learn_remaining] || 0 %></span>
      <span class="text-gray-300">+</span>
      <span class="count-review"><%= @session_stats[:review_remaining] || 0 %></span>
    </div>
    <div class="flex items-center gap-2">
      <span class="text-xs text-gray-400" data-study-target="timer">0:00</span>
      <button data-action="click->study#undo" class="p-1.5 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100" title="Undo (Ctrl+Z)">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
        </svg>
      </button>
    </div>
  </div>

  <%# Progress bar %>
  <div class="h-1 bg-gray-200 flex-shrink-0">
    <div class="h-full bg-blue-500 transition-all duration-300" style="width: <%= @session_stats[:progress_percent] || 0 %>%"></div>
  </div>

  <%# Card area %>
  <div class="flex-1 flex flex-col items-center justify-center px-4 overflow-y-auto">
    <div id="card-display" class="w-full max-w-2xl">
      <%# Front side %>
      <div id="card-front" class="study-card" data-study-target="front">
        <div class="prose max-w-none text-center">
          <%= raw @card_front %>
        </div>
      </div>

      <%# Back side (hidden initially) %>
      <div id="card-back" class="hidden" data-study-target="back">
        <div class="study-card">
          <div class="prose max-w-none text-center">
            <%= raw @card_front %>
          </div>
          <hr class="answer-divider w-full">
          <div class="prose max-w-none text-center">
            <%= raw(@card_back || "") %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# Bottom area: buttons %>
  <div class="bg-white border-t border-gray-200 px-4 py-3 flex-shrink-0">
    <%# Show Answer button %>
    <div id="answer-buttons" data-study-target="showAnswerBtn" class="max-w-2xl mx-auto">
      <button type="button"
              data-action="click->study#showAnswer"
              class="w-full py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-colors text-lg">
        Show Answer
      </button>
    </div>

    <%# Rating buttons (hidden initially) %>
    <div id="rating-buttons" class="hidden max-w-2xl mx-auto" data-study-target="ratingButtons">
      <%= form_with url: answer_deck_study_session_path(@deck), method: :post,
          data: { "study-target": "answerForm", "action": "submit->study#submitAnswer" } do |form| %>
        <%= form.hidden_field :card_id, value: @card.id, data: { "study-target": "cardId" } %>
        <%= form.hidden_field :time_ms, value: 0, data: { "study-target": "timeMs" } %>
      <% end %>

      <div class="grid grid-cols-4 gap-2">
        <button type="button" data-action="click->study#rate" data-rating="1" class="btn-again flex flex-col items-center py-3">
          <span class="text-xs opacity-75 mb-1"><%= @session_stats[:intervals]&.dig(:again) || "< 1m" %></span>
          <span>Again</span>
        </button>
        <button type="button" data-action="click->study#rate" data-rating="2" class="btn-hard flex flex-col items-center py-3">
          <span class="text-xs opacity-75 mb-1"><%= @session_stats[:intervals]&.dig(:hard) || "6m" %></span>
          <span>Hard</span>
        </button>
        <button type="button" data-action="click->study#rate" data-rating="3" class="btn-good flex flex-col items-center py-3">
          <span class="text-xs opacity-75 mb-1"><%= @session_stats[:intervals]&.dig(:good) || "10m" %></span>
          <span>Good</span>
        </button>
        <button type="button" data-action="click->study#rate" data-rating="4" class="btn-easy flex flex-col items-center py-3">
          <span class="text-xs opacity-75 mb-1"><%= @session_stats[:intervals]&.dig(:easy) || "4d" %></span>
          <span>Easy</span>
        </button>
      </div>
    </div>

    <%# Bottom toolbar %>
    <div class="max-w-2xl mx-auto mt-2 flex items-center justify-between text-xs text-gray-400">
      <div class="flex items-center gap-3">
        <% if @card.note %>
          <%= link_to edit_note_path(@card.note), class: "hover:text-gray-600 flex items-center gap-1", title: "Edit note (E)" do %>
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            Edit
          <% end %>
        <% end %>
      </div>
      <div class="flex items-center gap-1">
        <span>Shortcut: <kbd class="px-1 py-0.5 bg-gray-100 rounded text-[10px]">Space</kbd> show answer, <kbd class="px-1 py-0.5 bg-gray-100 rounded text-[10px]">1-4</kbd> rate</span>
      </div>
      <div class="relative" data-controller="dropdown">
        <button data-action="click->dropdown#toggle" class="hover:text-gray-600 flex items-center gap-1">
          More
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div data-dropdown-target="menu" class="hidden absolute right-0 bottom-full mb-1 w-48 bg-white rounded-md shadow-lg border border-gray-200 z-20 py-1">
          <div class="px-3 py-1.5 text-xs font-semibold text-gray-400 uppercase">Flag</div>
          <a href="#" class="block px-4 py-1.5 text-sm text-gray-700 hover:bg-gray-100">
            <span class="inline-block w-3 h-3 rounded-sm bg-red-500 mr-2"></span>Red
          </a>
          <a href="#" class="block px-4 py-1.5 text-sm text-gray-700 hover:bg-gray-100">
            <span class="inline-block w-3 h-3 rounded-sm bg-orange-500 mr-2"></span>Orange
          </a>
          <a href="#" class="block px-4 py-1.5 text-sm text-gray-700 hover:bg-gray-100">
            <span class="inline-block w-3 h-3 rounded-sm bg-green-500 mr-2"></span>Green
          </a>
          <a href="#" class="block px-4 py-1.5 text-sm text-gray-700 hover:bg-gray-100">
            <span class="inline-block w-3 h-3 rounded-sm bg-blue-500 mr-2"></span>Blue
          </a>
          <hr class="my-1 border-gray-200">
          <a href="#" class="block px-4 py-1.5 text-sm text-gray-700 hover:bg-gray-100">Bury Card</a>
          <a href="#" class="block px-4 py-1.5 text-sm text-gray-700 hover:bg-gray-100">Bury Note</a>
          <a href="#" class="block px-4 py-1.5 text-sm text-gray-700 hover:bg-gray-100">Suspend Card</a>
          <a href="#" class="block px-4 py-1.5 text-sm text-red-600 hover:bg-red-50">Delete Note</a>
        </div>
      </div>
    </div>
  </div>
</div>
