<%# Browser sidebar: search, decks, note types, tags, flags, saved searches %>
<%
  sidebar_saved_searches = current_user.saved_searches.where(deleted_at: nil).ordered
  sidebar_decks = current_user.decks.where(deleted_at: nil).roots.ordered.includes(:children)
  sidebar_note_types = current_user.note_types.where(deleted_at: nil).ordered
  sidebar_note_type_counts = current_user.notes.where(deleted_at: nil).group(:note_type_id).count
  sidebar_tags = current_user.notes.where(deleted_at: nil)
                  .where.not(tags: nil).where.not(tags: [])
                  .pluck(:tags).flatten.tally.sort_by { |name, _| name }
  sidebar_flag_names = current_user.flag_names.index_by(&:flag_number)
  sidebar_flag_counts = Card.joins(:deck).where(decks: { user_id: current_user.id }).where("flag > 0").group(:flag).count
  total_cards = Card.joins(:deck).where(decks: { user_id: current_user.id }).count
  default_flag_colors = { 1 => '#EF4444', 2 => '#F97316', 3 => '#22C55E', 4 => '#3B82F6', 5 => '#EC4899', 6 => '#14B8A6', 7 => '#8B5CF6' }
  default_flag_names = { 1 => 'Red', 2 => 'Orange', 3 => 'Green', 4 => 'Blue', 5 => 'Pink', 6 => 'Turquoise', 7 => 'Purple' }
%>

<div class="h-full flex flex-col browser-sidebar">
  <%# Search %>
  <div class="p-3 border-b border-gray-200">
    <div class="relative">
      <input type="text" placeholder="Search..."
             class="form-input pl-8 text-sm"
             data-browser-target="sidebarSearch">
      <svg class="absolute left-2.5 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
    </div>
  </div>

  <div class="flex-1 overflow-y-auto p-2 space-y-1">
    <%# Saved Searches %>
    <div data-controller="collapsible" data-collapsible-open-value="true">
      <div class="collapsible-header" data-action="click->collapsible#toggle">
        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Saved Searches</span>
        <svg data-collapsible-target="icon" class="w-3.5 h-3.5 text-gray-400 transition-transform" style="transform: rotate(90deg)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </div>
      <div data-collapsible-target="content" class="pl-3 space-y-0.5">
        <% sidebar_saved_searches.each do |search| %>
          <a href="#" class="block px-3 py-1 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 rounded" data-action="click->browser#filterSavedSearch" data-query="<%= search.search_query %>">
            <%= search.name %>
          </a>
        <% end %>
      </div>
    </div>

    <%# Decks %>
    <div data-controller="collapsible" data-collapsible-open-value="true">
      <div class="collapsible-header" data-action="click->collapsible#toggle">
        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Decks</span>
        <svg data-collapsible-target="icon" class="w-3.5 h-3.5 text-gray-400 transition-transform" style="transform: rotate(90deg)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </div>
      <div data-collapsible-target="content" class="pl-3 space-y-0.5">
        <a href="#" class="block px-3 py-1 text-sm text-blue-700 bg-blue-50 rounded font-medium">All Decks (<%= total_cards %>)</a>
        <% render_sidebar_decks = ->(decks, depth = 0) do %>
          <% decks.each do |deck| %>
            <a href="#" class="block px-3 py-1 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 rounded truncate"
               style="padding-left: <%= 12 + depth * 16 %>px"
               data-action="click->browser#filterDeck"
               data-deck="<%= deck.full_name %>">
              <%= deck.name %> (<%= deck.cards.size %>)
            </a>
            <% if deck.children.any? %>
              <% render_sidebar_decks.call(deck.children.order(:name), depth + 1) %>
            <% end %>
          <% end %>
        <% end %>
        <% render_sidebar_decks.call(sidebar_decks) %>
      </div>
    </div>

    <%# Note Types %>
    <div data-controller="collapsible" data-collapsible-open-value="true">
      <div class="collapsible-header" data-action="click->collapsible#toggle">
        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Note Types</span>
        <svg data-collapsible-target="icon" class="w-3.5 h-3.5 text-gray-400 transition-transform" style="transform: rotate(90deg)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </div>
      <div data-collapsible-target="content" class="pl-3 space-y-0.5">
        <% sidebar_note_types.each do |nt| %>
          <a href="#" class="block px-3 py-1 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 rounded"
             data-action="click->browser#filterNoteType"
             data-note-type="<%= nt.name %>">
            <%= nt.name %> (<%= sidebar_note_type_counts[nt.id] || 0 %>)
          </a>
        <% end %>
      </div>
    </div>

    <%# Tags %>
    <div data-controller="collapsible" data-collapsible-open-value="true">
      <div class="collapsible-header" data-action="click->collapsible#toggle">
        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Tags</span>
        <svg data-collapsible-target="icon" class="w-3.5 h-3.5 text-gray-400 transition-transform" style="transform: rotate(90deg)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </div>
      <div data-collapsible-target="content" class="pl-3 space-y-0.5">
        <% sidebar_tags.each do |tag_name, tag_count| %>
          <a href="#" class="block px-3 py-1 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 rounded"
             data-action="click->browser#filterTag"
             data-tag="<%= tag_name %>">
            <%= tag_name %> (<%= tag_count %>)
          </a>
        <% end %>
      </div>
    </div>

    <%# Flags %>
    <div data-controller="collapsible" data-collapsible-open-value="false">
      <div class="collapsible-header" data-action="click->collapsible#toggle">
        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Flags</span>
        <svg data-collapsible-target="icon" class="w-3.5 h-3.5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </div>
      <div data-collapsible-target="content" class="hidden pl-3 space-y-0.5">
        <% (1..7).each do |flag_num| %>
          <% flag_name_record = sidebar_flag_names[flag_num] %>
          <% flag_label = flag_name_record&.name.presence || default_flag_names[flag_num] %>
          <% flag_count = sidebar_flag_counts[flag_num] || 0 %>
          <a href="#" class="flex items-center gap-2 px-3 py-1 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 rounded">
            <span class="w-3 h-3 rounded-sm" style="background-color: <%= default_flag_colors[flag_num] %>"></span>
            <%= flag_label %> (<%= flag_count %>)
          </a>
        <% end %>
      </div>
    </div>
  </div>
</div>
