<% content_for :title, "Browse" %>
<% content_for :page_title, "Browse" %>

<div class="space-y-6" data-controller="browser">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Browse</h1>
      <p class="mt-1 text-sm text-gray-500">Search and manage your notes and cards</p>
    </div>
    <%= link_to new_note_path, class: "btn-primary" do %>
      Add Note
    <% end %>
  </div>

  <%# Search and Filters %>
  <div class="card">
    <%= form_with url: notes_path, method: :get, local: true, data: { controller: "search", action: "submit->search#submit" } do |form| %>
      <div class="space-y-4">
        <div>
          <%= form.label :search, "Search", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.text_field :search, 
              value: params[:search],
              placeholder: "Search notes...",
              class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
              data: { "search-target": "input" } %>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <%= form.label :deck_id, "Deck", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.collection_select :deck_id, 
                current_user.decks.roots.ordered, 
                :id, :name, 
                { selected: params[:deck_id], prompt: "All decks" }, 
                { class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" } %>
          </div>

          <div>
            <%= form.label :note_type_id, "Note Type", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.collection_select :note_type_id, 
                current_user.note_types.ordered, 
                :id, :name, 
                { selected: params[:note_type_id], prompt: "All note types" }, 
                { class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" } %>
          </div>

          <div>
            <%= form.label :tag, "Tag", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.text_field :tag, 
                value: params[:tag],
                placeholder: "Filter by tag...",
                class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" %>
          </div>
        </div>

        <div class="flex items-center space-x-4">
          <div class="flex items-center">
            <%= form.check_box :marked, { checked: params[:marked] == "true" }, "true", "" %>
            <%= form.label :marked, "Marked only", class: "ml-2 block text-sm text-gray-700" %>
          </div>
          <div class="flex items-center space-x-2">
            <%= form.submit "Search", class: "btn-primary" %>
            <%= link_to "Clear", notes_path, class: "btn-secondary" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <%# Results Table %>
  <div class="card">
    <% if @notes.any? %>
      <div class="mb-4 flex items-center justify-between">
        <p class="text-sm text-gray-600">
          Showing <%= @pagy.from %>-<%= @pagy.to %> of <%= @pagy.count %> notes
        </p>
        <div class="flex items-center space-x-2">
          <%= form_with url: notes_path, method: :get, local: true, class: "inline-flex items-center space-x-2" do |form| %>
            <% params.except(:page, :per_page).each do |key, value| %>
              <%= form.hidden_field key, value: value %>
            <% end %>
            <%= form.label :per_page, "Per page:", class: "text-sm text-gray-700" %>
            <%= form.select :per_page, [25, 50, 100], { selected: params[:per_page] || 25 }, 
                { class: "px-2 py-1 border border-gray-300 rounded-md text-sm", 
                  onchange: "this.form.submit()" } %>
          <% end %>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= sortable_column "Note Type", "note_types.name" %>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Fields
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Tags
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Cards
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <%= sortable_column "Updated", "notes.updated_at" %>
              </th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @notes.each do |note| %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <%= note.note_type.name %>
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">
                  <% if note.note_type %>
                    <% first_field = note.note_type.field_names.first %>
                    <div class="max-w-md truncate" title="<%= note.fields_json[first_field.to_s] if first_field %>">
                      <%= truncate(note.fields_json[first_field.to_s] || "", length: 50) if first_field %>
                    </div>
                  <% end %>
                </td>
                <td class="px-6 py-4 text-sm">
                  <div class="flex flex-wrap gap-1">
                    <% note.tags.first(3).each do |tag| %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                        <%= tag %>
                      </span>
                    <% end %>
                    <% if note.tags.size > 3 %>
                      <span class="text-xs text-gray-500">+<%= note.tags.size - 3 %></span>
                    <% end %>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <%= note.cards.count %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <%= time_ago_in_words(note.updated_at) %> ago
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <%= link_to "View", note_path(note), class: "text-blue-600 hover:text-blue-900 mr-3" %>
                  <%= link_to "Edit", edit_note_path(note), class: "text-blue-600 hover:text-blue-900 mr-3" %>
                  <%= link_to "Delete", note_path(note), method: :delete, 
                      confirm: "Are you sure?", 
                      class: "text-red-600 hover:text-red-900" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <%# Pagination %>
      <div class="mt-6">
        <%== pagy_nav(@pagy) if @pagy.pages > 1 %>
      </div>
    <% else %>
      <div class="text-center py-12">
        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No notes found</h3>
        <p class="text-gray-500 mb-4">
          <% if params[:search].present? || params[:deck_id].present? || params[:note_type_id].present? || params[:tag].present? %>
            Try adjusting your search or filters.
          <% else %>
            Get started by creating your first note.
          <% end %>
        </p>
        <% unless params[:search].present? || params[:deck_id].present? || params[:note_type_id].present? || params[:tag].present? %>
          <%= link_to "Add Note", new_note_path, class: "btn-primary" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
